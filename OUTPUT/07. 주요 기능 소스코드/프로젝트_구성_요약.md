## Teamcover 프로젝트 구성 요약 (Frontend & Backend)

이 문서는 현재 Teamcover 레포지토리 기준으로 **폴더 구조와 주요 파일/핵심 함수**를 한눈에 보기 좋게 정리한 개요입니다.

---

### 1. Frontend 구성 (React)

- **엔트리 & 라우팅**

  - `src/index.js`
    - React 앱 부트스트랩, `BrowserRouter`로 라우팅 설정.
  - `src/App.js`
    - 전역 Provider 래핑: `ThemeProvider` → `AuthProvider` → `ClubProvider`.
    - `Navbar`, `Footer`, `FloatingMessageButton`, `PushNotificationManager`를 공통 레이아웃으로 렌더.
    - `react-router-dom` `Routes`로 주요 페이지 라우팅:
      - `/` → `Landing`
      - `/login` → `Login`
      - `/verify-email`, `/verify-code`
      - `/members`, `/payments`, `/team-assignment`, `/user-management` 등은 `ProtectedRoute` + `requiredRole`로 접근 제어.

- **전역 컨텍스트**

  - `contexts/AuthContext.js`

    - **핵심 역할**: 로그인 상태, JWT 토큰, 사용자 정보, 권한, FCM 푸시 알림, 비활성 자동 로그아웃, 안 읽은 메시지/문의 알림 관리.
    - **주요 함수**
      - `login(email, password)`
        - `/api/auth/login` 호출 → `user`, `access_token` 저장, `localStorage('token')` 세팅.
        - FCM 토큰 등록(`registerFCMToken`) 및 개인정보 토큰 초기화.
      - `googleLogin(jwtToken)`
        - JWT로 현재 사용자 조회 → `user`, `token` 세팅.
      - `register(...)`
        - `/api/auth/register` 호출, 클럽 ID 포함 회원가입 처리.
      - `logout()`
        - `/api/auth/logout` 호출 후 `user`, `token` 및 `localStorage` 초기화.
      - `logoutOtherDevices()`
        - 다른 기기의 세션 종료용 `/api/auth/logout-other-devices` 호출.
      - `hasRole(requiredRole)`
        - `user.role`을 `user < admin < super_admin` 계층으로 비교.
      - `canAccessPage(page)`
        - 경로별 접근 권한 판단(`/members`, `/scores` 등).
      - 내부 `useEffect` 로직들
        - 토큰 존재 시 `getCurrentUser` 호출.
        - FCM `setupMessageListener`로 실시간 푸시 알림 처리.
        - `messageAPI.getUnreadCount`, `inquiryAPI.getUnreadCount` 로 30초마다 안 읽은 메시지/문의 체크 및 웹 알림 표시.
        - 10분 이상 무활동 시 자동 로그아웃 및 `/login` 리다이렉트.

  - `contexts/ClubContext.js`
    - **핵심 역할**: 사용자가 속한 클럽 목록, 현재 선택 클럽, 클럽 생성/가입/탈퇴, 클럽 권한(운영진 여부) 관리.
    - **주요 함수**
      - `loadClubs()`
        - `/api/clubs/`(getUserClubs) 호출 → 승인된 클럽 목록 로드.
        - `localStorage('currentClubId')` 기반으로 현재 클럽 복원, 없으면 (1개일 때만) 자동 선택.
      - `selectClub(clubId)`
        - `/api/clubs/{id}/select` 호출 → 서버에 선택 클럽 반영 후 페이지 전체 새로고침.
      - `createClub(clubData)`
        - `/api/clubs` 생성 → 목록 새로고침 + 새 클럽 선택.
      - `joinClub(clubId)`, `leaveClub(clubId)`
        - 클럽 가입/탈퇴 로직 및 `currentClub`/`localStorage` 동기화.
      - `isAdmin`, `isOwner`
        - 현재 클럽에서의 역할(`admin`, `owner`) 여부를 계산하여 반환.

- **라우트 보호**

  - `components/ProtectedRoute.js`
    - **역할**: 로그인 여부 및 역할 기반으로 페이지 접근 제어.
    - **핵심 로직**
      - `!isAuthenticated` → `/login` 리다이렉트.
      - `requiredRole === 'admin'`
        - 시스템 역할(`hasRole('admin')`) 또는 클럽 운영진(`isClubAdmin`) 또는 `super_admin`만 허용.
      - 그 외(`requiredRole === 'user'` 등)
        - `hasRole(requiredRole)` 또는 `super_admin`만 허용.
      - 로딩 중(`AuthContext.loading`/`ClubContext.loading`)에는 스피너 표시.

- **API 래퍼**
  - `services/api.js`
    - `axios` 인스턴스 `api` 생성 (`API_BASE_URL = process.env.REACT_APP_API_URL`).
    - **요청 인터셉터**
      - HTTP → HTTPS 자동 변환(로컬 제외).
      - `localStorage`의 `token` 또는 `temp_reset_token`을 `Authorization: Bearer`로 삽입.
      - `privacy_token` → `X-Privacy-Token` 헤더.
      - `currentClubId` → `X-Club-Id` 헤더.
    - **주요 네임스페이스**
      - `memberAPI`: `/api/members` CRUD, 평균 점수/티어 조회 및 일괄 업데이트, 개인정보 토큰 검증.
      - `scoreAPI`: `/api/scores` CRUD, 에버 순위 조회/새로고침.
      - `pointAPI`: `/api/points` CRUD 및 시트 연동.
      - `paymentAPI`: 납입 내역 CRUD, 통계, 잔액 설정, 장부(FundLedger) CRUD.
      - `authAPI`: 로그인/회원가입/비밀번호 찾기, 사용자/역할 관리, FCM 토큰 등록 등.
      - `clubAPI`: 클럽 목록/상세, 가입/탈퇴, 멤버 역할 변경, 가입 요청 관리.
      - `postAPI`: 게시판(글/댓글/좋아요/이미지 업로드).
      - `messageAPI`: 1:1 메시지(대화 목록, 메시지 전송/삭제, 읽기 처리).
      - `inquiryAPI`: 문의/답변/댓글 및 미응답 문의 수 조회.

---

### 2. Backend 구성 (Flask + SQLAlchemy)

- **진입점**

  - `backend/app.py`
    - Flask 앱 생성 및 설정(`Config` 로드, 세션/쿠키/JWT 설정).
    - `LoginManager`, `JWTManager`, `CORS` 초기화.
    - **JWT 블랙리스트 로직**: `@jwt.token_in_blocklist_loader check_if_token_revoked`
      - `User.active_token`과 현재 토큰의 `jti`를 비교해 로그아웃/다른 기기 로그아웃 처리.
    - `unauthorized_handler`에서 OPTIONS 요청은 200으로 처리, 그 외는 JSON 401 반환.
    - `db.init_app(app)` + 앱 시작 시 DB 연결/테이블 생성 및 재시도 로직.
    - Blueprint 등록:
      - `auth_bp`, `members_bp`, `scores_bp`, `points_bp`, `teams_bp`, `ocr_bp`, `payments_bp`, `posts_bp`, `clubs_bp`, `messages_bp`, `inquiries_bp`, `sheets_bp(옵션)`.
    - 공용 엔드포인트
      - `/uploads/<filename>`: 업로드 이미지 서빙.
      - `/health`, `/health/db`: 헬스체크 및 DB 연결 상태 확인.
      - `/`: API 서버 정보 및 주요 엔드포인트 목록 JSON 반환.
    - CLI 명령
      - `flask init-db`: `db.create_all()`로 DB 초기화.
      - `flask create-super-admin`: 슈퍼관리자 계정 생성 인터랙티브 명령.

- **모델 정의**

  - `backend/models.py`
    - `User`: 로그인/권한/FCM/활성 토큰/개인정보 비밀번호 관리.
      - `set_password`, `check_password`, `set_privacy_password`, `check_privacy_password`, `to_dict`.
    - `Club`, `ClubMember`: 클럽 및 사용자-클럽 다대다 관계, 역할(`member/admin/owner`) 및 승인 상태 관리.
    - `Member` (클럽 내 회원)
      - 평균 점수/티어 계산 핵심 비즈니스 로직:
        - `calculate_regular_season_average()`: 반기 기준 에버 계산(현재 반기 → 이전 반기 → 이전 연도 순서).
        - `calculate_tier_from_score()`: 상위 백분위 기준 티어 매핑(챌린저 ~ 아이언).
        - `update_average_score`, `update_tier`, `update_average_and_tier`.
        - `to_dict(hide_privacy)`: 개인정보 마스킹(전화/이메일) 지원.
    - `Score`
      - 정기전 점수 기록(3게임, 총점, 평균, 시즌 정보).
      - `set_season_info()`: 시즌 연도/반기(`1H/2H`) 자동 설정.
      - `update_member_tier()`: 스코어 추가/수정/삭제 후 회원 평균/티어 업데이트.
    - `Point`: 포인트 적립/사용 기록(정산과 연계).
    - `Payment`: 납입(월회비/정기전) 기록, `to_dict()`로 프론트 응답용 변환.
    - `FundState`, `FundLedger`: 회비 시작월/잔액 및 장부(입금/출금) 기록.
    - `Message`, `Inquiry`, `InquiryReplyComment`, `Post`, `PostImage`, `Comment`, `CommentLike`, `Like`, `AppSetting` 등
      - 1:1 메시지, 문의/답변/댓글, 게시판과 관련된 모든 데이터 구조 정의.

- **주요 블루프린트 (예시)**  
  (모든 Blueprint는 `utils.club_helpers`를 통해 `X-Club-Id` 기반 클럽 컨텍스트와 권한을 검사합니다.)

  - `blueprints/members.py` (`/api/members`)

    - `get_members() [GET /]`
      - 클럽별 회원 목록 조회, 역할/개인정보 토큰에 따라 전화/이메일 마스킹 제어.
      - 신규 회원 수, 성별 분포, 레벨/티어 카운트 등의 통계 포함.
    - `add_member() [POST /]`
      - 관리자/운영진만 회원 추가 가능.
      - 운영진으로 등록 시 해당 연도 월회비 면제 `Payment` 레코드 자동 생성/변경.
    - `update_member(member_id) [PUT /<id>]`
      - 개인정보 마스킹된 값(`***-****-****`)은 무시하고 기존 데이터 유지.
      - 운영진 상태 변경 시 향후 월 회비 면제/해제 로직 자동 반영.
    - `delete_member(member_id) [DELETE /<id>]`
      - Soft Delete (`is_deleted=True`)로 처리, 스코어/포인트/결제 이력은 유지.
    - 평균/티어 관련 API:
      - `get_member_average(member_id)`: 개인 에버 및 티어 조회(없으면 계산 후 저장).
      - `update_all_member_averages()`: 전체 회원 평균/티어 일괄 갱신(관리자 전용).
      - `get_all_members_averages()`: 특정 기준 이후 점수 기반 에버 리스트 최적화 조회.
    - 개인정보 접근:
      - `verify_privacy_access()`: 운영진용 개인정보 보호 비밀번호 검증 + 임시 `privacy_token` 발급.
      - `check_privacy_status()`: 현재 사용자의 개인정보 잠금 해제 여부 반환.

  - `blueprints/scores.py` (`/api/scores`)

    - `get_scores()`: 클럽별 스코어 목록 + 회원 이름 포함 반환.
    - `add_score()`: 이름 기반 회원 매칭 후 스코어 등록, 시즌 정보/평균/티어 자동 업데이트.
    - `update_score()`, `delete_score()`: 수정/삭제 후에도 회원 평균/티어 재계산.
    - `get_member_averages()`: DB 윈도우 함수(`DENSE_RANK`)로 평균 점수 순위 조회.
    - `refresh_member_averages()`: 클럽별 전체 회원 에버 재계산 + 순위 포함 응답.

  - `blueprints/payments.py` (`/api/payments`)
    - `get_payments()`: 필터(회원/타입/월) + 통계(총액, 월회비/정기전 합계).
    - `add_payment()`, `update_payment()`, `delete_payment()`
      - 납입/면제/포인트 납부 여부에 따라:
        - 장부(`FundLedger`) 동기화 (`_sync_payment_to_ledger`).
        - 포인트(`Point`) 차감 내역 자동 생성/수정/삭제.
    - `get_payment_stats()`: 월별 회비/정기전 합계를 DB 레벨에서 집계.
    - `fund_ledger_endpoint()`, `manage_fund_ledger_item()`
      - 장부 조회/수기 추가/수정/삭제 API (관리자/운영진 전용).
    - `payment_balance()`
      - 회비 잔액 및 시작월(`AppSetting`) 조회/수정.

---

### 3. 이 파일을 어떻게 활용하면 좋은가

- **신규 팀원 온보딩용**
  - 이 문서를 먼저 읽고, 궁금한 기능이 있으면
    - 프론트: `services/api.js`의 해당 API 래퍼 → 사용하는 페이지/컨텍스트
    - 백엔드: `app.py`의 엔드포인트 맵 → 해당 Blueprint/모델
    - 순서로 코드를 따라가면 전체 흐름을 빠르게 이해할 수 있습니다.
- **아키텍처 리뷰/리팩터링 계획용**
  - 기능별로 “어느 층(페이지/컨텍스트/API/Blueprint/Model)에 로직이 집중되어 있는지” 파악할 수 있어, 책임 분리나 공통화 후보를 찾을 때 기준점으로 사용할 수 있습니다.

